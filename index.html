<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>口臭＆健康リスク診断 | 下関市</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; letter-spacing: -0.01em; color: #0F172A; -webkit-tap-highlight-color: transparent; }
        .page { display: none; }
        .active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .bg-main { background-color: #F8FAFC; }
        .progress-bar { transition: width 0.4s ease; }
        .opt-btn-text { font-size: 1.1rem !important; font-weight: 800; color: #0F172A; }
        .score-blue { color: #0ea5e9; } .bg-blue-tag { background-color: #e0f2fe; color: #0369a1; }
        .score-yellow { color: #eab308; } .bg-yellow-tag { background-color: #fefce8; color: #854d0e; }
        .score-red { color: #ef4444; } .bg-red-tag { background-color: #fef2f2; color: #991b1b; }
        .my-icon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 100; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); object-fit: cover; border: 2px solid white; }
    </style>
</head>
<body class="bg-main">

    <img src="my-icon.png" class="my-icon" alt="Brand Icon">

    <header class="bg-white border-b sticky top-0 z-50 px-4 py-3 shadow-sm">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <span class="text-sky-600 font-black text-lg italic tracking-tighter">KUCHI-CHECK</span>
            <span id="q-counter" class="text-[10px] font-black bg-sky-100 text-sky-600 px-3 py-1 rounded-full uppercase">READY</span>
        </div>
        <div class="max-w-md mx-auto w-full bg-slate-100 h-1.5 mt-2 rounded-full overflow-hidden">
            <div id="progress" class="progress-bar bg-sky-400 h-full" style="width: 0%"></div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-24">
        
        <section id="page-start" class="page active py-6 text-center">
            <h1 class="text-3xl font-black mb-4 leading-tight">あなたの息は<br><span class="text-sky-500 text-4xl underline decoration-yellow-300 decoration-8">「体の鏡」</span>です</h1>
            
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 mb-8 text-left">
                <h2 class="text-sky-600 font-black text-lg mb-3">この診断でわかること</h2>
                <ul class="text-sm font-bold text-slate-600 space-y-3">
                    <li class="flex items-start"><span class="text-sky-400 mr-2">●</span>お口のニオイの原因が「一時的なもの」か「病気のサイン」かを分析します。</li>
                    <li class="flex items-start"><span class="text-sky-400 mr-2">●</span>生活習慣やストレスからくる体調の変化をチェックします。</li>
                    <li class="flex items-start"><span class="text-sky-400 mr-2">●</span>あなたに最適なセルフケアと下関市の健康情報を提案します。</li>
                </ul>
                <p id="liff-status" class="text-xs text-slate-400 font-medium italic mt-6 text-center">LINEと接続しています...</p>
            </div>
            
            <button id="start-btn" onclick="startQuiz()" class="w-full bg-sky-500 text-white font-black py-6 rounded-3xl shadow-lg active:scale-95 transition-all text-xl disabled:bg-slate-300" disabled>診断を開始する</button>
            <p class="text-[10px] text-slate-400 mt-4">※この診断は医療診断に代わるものではありません。</p>
        </section>

        <section id="page-q" class="page">
            <div class="bg-white rounded-[3rem] p-8 shadow-2xl border border-sky-50 mt-4 relative">
                <div class="flex justify-between items-start mb-6">
                    <div id="q-cat-label" class="inline-block px-4 py-1.5 rounded-full text-[10px] font-black tracking-widest text-white bg-sky-400 uppercase">CATEGORY</div>
                    <button id="back-btn" onclick="prevQuestion()" class="hidden text-[10px] font-black text-slate-400 flex items-center bg-slate-100 px-3 py-1.5 rounded-full active:bg-slate-200">
                        <span class="mr-1">◀</span> 戻る
                    </button>
                </div>
                <h2 id="q-text" class="text-xl font-black mb-8 leading-tight text-slate-800 min-h-[4rem]"></h2>
                <div id="q-image-area" class="mb-8 hidden">
                    <div class="grid grid-cols-3 gap-2 text-[9px] font-bold text-slate-400 text-center">
                        <div><img src="tongue1.jpg" class="rounded-xl border mb-1 aspect-square object-cover shadow-sm">真っ白</div>
                        <div><img src="tongue2.jpg" class="rounded-xl border mb-1 aspect-square object-cover shadow-sm">うっすら</div>
                        <div><img src="tongue3.jpg" class="rounded-xl border mb-1 aspect-square object-cover shadow-sm">きれい</div>
                    </div>
                </div>
                <div id="options-container" class="space-y-4"></div>
            </div>
        </section>

        <section id="page-result" class="page">
            <h2 class="text-center font-black text-2xl mb-2 tracking-tighter italic text-slate-800 uppercase">Diagnostic Report</h2>
            <p class="text-center text-sky-600 font-black text-sm mb-6 underline">現在の口臭リスク分析</p>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white p-5 rounded-[2.5rem] shadow-xl border border-sky-50 text-center">
                    <p class="text-[10px] font-black mb-1 uppercase opacity-60">一時的リスク</p>
                    <div class="flex items-center justify-center font-black"><span id="score-1" class="text-5xl">0</span><span class="text-sm ml-1">%</span></div>
                    <p id="label-1" class="text-[10px] font-black rounded-full py-1 mt-3"></p>
                </div>
                <div class="bg-white p-5 rounded-[2.5rem] shadow-xl border border-sky-50 text-center">
                    <p class="text-[10px] font-black mb-1 uppercase opacity-60">病的リスク</p>
                    <div class="flex items-center justify-center font-black"><span id="score-2" class="text-5xl">0</span><span class="text-sm ml-1">%</span></div>
                    <p id="label-2" class="text-[10px] font-black rounded-full py-1 mt-3"></p>
                </div>
            </div>

            <div class="bg-sky-50/50 p-4 rounded-2xl mb-8 border border-sky-100">
                <div class="text-[9px] text-slate-500 font-bold leading-relaxed space-y-1">
                    <p><b class="text-sky-600">●一時的リスク：</b> 疲れ・緊張・乾燥など、生活リズムの乱れによるニオイの発生しやすさです。</p>
                    <p><b class="text-sky-600">●病的リスク：</b> 歯周病や胃腸の不調など、身体的な要因が原因となっている可能性の高さです。</p>
                </div>
            </div>

            <div id="result-message" class="bg-white p-6 rounded-3xl mb-10 shadow-md border-l-8 text-sm font-bold text-slate-700 leading-relaxed"></div>

            <div class="mb-10">
                <h3 class="font-black text-sky-600 text-sm mb-4 flex items-center"><span class="w-3 h-3 bg-sky-400 mr-2 rounded-full"></span>あなた専用のアドバイス</h3>
                <div id="advice-list" class="grid gap-3"></div>
            </div>

            <div class="bg-white border-2 border-slate-100 rounded-[2.5rem] p-8 mb-6 shadow-xl">
                <h3 class="text-xl font-black mb-4 italic text-sky-500 text-center">SHIMONOSEKI INFO</h3>
                <div class="space-y-3">
                    <a href="https://www.city.shimonoseki.lg.jp/soshiki/42/5040.html" target="_blank" class="block w-full bg-slate-700 border border-slate-700 text-center font-bold py-4 rounded-2xl text-sm transition-all no-underline text-white active:bg-slate-800">特定健診（40歳〜74歳）</a>
                    <a href="https://www.city.shimonoseki.lg.jp/soshiki/51/5768.html" target="_blank" class="block w-full bg-slate-700 border border-slate-700 text-center font-bold py-4 rounded-2xl text-sm transition-all no-underline text-white active:bg-slate-800">健康診査（全般）</a>
                </div>
            </div>

            <button onclick="liff.closeWindow()" class="w-full bg-slate-400 text-white font-black py-6 rounded-3xl text-lg active:scale-95 shadow-md">診断を終了する</button>
        </section>
    </main>

    <script>
        const LIFF_ID = "2008714027-cuYvg8O7"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz66OWd1XQd37zZAN7TQka0gq0KWDvkoXtX8xvSZhpkNKOwMcOsLivP_HVb1v_TbH5rXw/exec"; 

        const questions = [
            { axis: 1, cat: "起床・空腹", text: "朝起きたときや、お腹が空いているときに特にお口が臭う。", labels: ["よくある","たまにある","ない"], advice: "朝一番の水分補給が、爽やかさを作るコツです。" },
            { axis: 1, cat: "舌の汚れ", text: "鏡で舌を見たとき、表面が白く厚く覆われている。", labels: ["真っ白","うっすら","きれい"], advice: "朝の歯磨き前に「舌ブラシ」で優しくケアしましょう。", hasImage: true },
            { axis: 1, cat: "ストレス", text: "現在、仕事や家庭などで強いストレスを感じている。", labels: ["常に強い","時々","あまりない"], advice: "深呼吸を3回するだけでも唾液は出やすくなります。" },
            { axis: 1, cat: "ネバつき", text: "緊張すると口の中がネバネバし、話しにくいと感じることがある。", labels: ["よくある","たまにある","ない"], advice: "唾液腺マッサージで、サラサラ唾液を呼び戻しましょう。" },
            { axis: 1, cat: "水分摂取", text: "日中、水やお茶などの水分をあまり摂らない。", labels: ["摂らない","時々","こまめに摂る"], advice: "一口ずつ、こまめに口を潤す習慣をつけましょう。" },
            { axis: 1, cat: "ホルモン", text: "（女性の方）生理前後や更年期の時期に当たっている。", labels: ["はい","どちらでもない","いいえ"], advice: "丁寧な歯磨きと、たっぷりの休息を大切に。" },
            { axis: 1, cat: "体調・疲労", text: "睡眠不足や疲れが溜まっていて、体調が万全ではない。", labels: ["かなり疲労","やや疲れ","元気"], advice: "今日はいつもより30分早く寝てみませんか？" },
            { axis: 1, cat: "飲食", text: "昨夜、ニンニク料理を食べたり、お酒を多めに飲んだ。", labels: ["はい","少し","いいえ"], advice: "リンゴジュースが一時的なニオイの分解を助けます。" },
            { axis: 1, cat: "セルフケア", text: "1日の歯磨き回数が、2回以下である。", labels: ["1回以下","2回","3回以上"], advice: "食後のブクブクうがいだけでも細菌の増殖を抑えられます。" },
            { axis: 1, cat: "口呼吸", text: "寝ている時に、口が開いていると指摘されたことがある。", labels: ["よくある","たまにある","ない"], advice: "意識的な鼻呼吸と、寝る前の水分補給を大切に。" },
            { axis: 2, cat: "継続性", text: "口臭の悩みが2週間以上、長く続いている。", labels: ["ずっと","時々","ない"], advice: "長く続く場合は、一度専門家のチェックを受けましょう。" },
            { axis: 2, cat: "歯ぐき", text: "歯を磨くとき、特定の場所から血が出ることがある。", labels: ["毎回","時々","ない"], advice: "出血は歯周病のサイン。早めの受診をおすすめします。" },
            { axis: 2, cat: "歯の異変", text: "歯がグラついたり、歯ぐきが腫れたりしている場所がある。", labels: ["ある","違和感","ない"], advice: "放置は危険です。早めに歯科医院へ。" },
            { axis: 2, cat: "代謝サイン", text: "以前より喉が異常に渇き、トイレの回数が増えた。", labels: ["よくある","たまに","ない"], advice: "内分泌の健診で数値を一度確認してみましょう。" },
            { axis: 2, cat: "鼻・喉", text: "鼻が詰まりやすかったり、喉の奥に鼻水が落ちる感覚がある。", labels: ["よくある","たまに","ない"], advice: "耳鼻科への相談が改善の近道になることもあります。" },
            { axis: 2, cat: "だるさ", text: "お酒を飲まないのに、体がだるかったり足がむくみやすい。", labels: ["よくある","たまに","ない"], advice: "内臓の疲れが原因かも。定期健診を習慣にしましょう。" },
            { axis: 2, cat: "消化器", text: "胃もたれ、胸焼け、または慢性の胃痛に悩まされている。", labels: ["よくある","たまに","ない"], advice: "消化に良い食事を心がけ、体を内側から労わって。" },
            { axis: 2, cat: "タバコ", text: "日常的にタバコを吸っている。", labels: ["吸う","以前吸っていた","吸わない"], advice: "タバコは深刻な病気を隠します。本数を減らす一歩から。" },
            { axis: 2, cat: "血糖値サイン", text: "急に甘いものが欲しくなったり、食後に強い眠気を感じる。", labels: ["よくある","たまに","ない"], advice: "食後の強い眠気は血糖値のサイン。健診を受けましょう。" },
            { axis: 2, cat: "むくみ", text: "夕方に靴がきつく感じることが増えたりした。", labels: ["よくある","たまに","ない"], advice: "軽いストレッチでお口と全身の巡りを良くしましょう。" }
        ];

        let currentIdx = 0, answers = [], lineProfile = null;

        window.onload = async () => {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    lineProfile = await liff.getProfile();
                    document.getElementById('liff-status').innerText = `${lineProfile.displayName}さん、準備完了！`;
                    document.getElementById('start-btn').disabled = false;
                } else { liff.login(); }
            } catch (e) {
                document.getElementById('liff-status').innerText = "デモモード起動中...";
                document.getElementById('start-btn').disabled = false;
            }
        };

        function startQuiz() { currentIdx = 0; answers = []; showPage('page-q'); updateQuestion(); }
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }

        function updateQuestion() {
            const q = questions[currentIdx];
            document.getElementById('q-counter').innerText = `Q${currentIdx + 1} / 20`;
            document.getElementById('progress').style.width = `${((currentIdx + 1) / 20) * 100}%`;
            document.getElementById('q-cat-label').innerText = q.cat;
            document.getElementById('q-text').innerText = q.text;
            document.getElementById('q-image-area').classList.toggle('hidden', !q.hasImage);
            const backBtn = document.getElementById('back-btn');
            if (currentIdx > 0) backBtn.classList.remove('hidden'); else backBtn.classList.add('hidden');
            const container = document.getElementById('options-container');
            container.innerHTML = "";
            q.labels.forEach((label, i) => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white border-2 border-slate-100 p-6 rounded-3xl text-left shadow-sm active:bg-sky-50 flex justify-between items-center";
                btn.innerHTML = `<span class="opt-btn-text text-sm font-bold">${label}</span><span class="text-sky-300">→</span>`;
                btn.onclick = () => {
                    answers.push({ ...q, userScore: (i === 0 ? 1 : (i === 1 ? 0.5 : 0)) });
                    if (currentIdx < questions.length - 1) { currentIdx++; updateQuestion(); } else { showResult(); }
                };
                container.appendChild(btn);
            });
        }

        function prevQuestion() {
            if (currentIdx > 0) {
                currentIdx--;
                answers.pop();
                updateQuestion();
            }
        }

        function showResult() {
            showPage('page-result');
            let s1 = 0, s2 = 0;
            const adviceSet = [];
            answers.forEach(a => {
                let p = a.userScore * 10;
                if (a.axis === 1) s1 += p; else s2 += p;
                if (a.userScore >= 0.5) adviceSet.push(a.advice);
            });
            const renderScore = (score, scoreId, labelId) => {
                const el = document.getElementById(scoreId);
                const lbl = document.getElementById(labelId);
                el.innerText = Math.round(score);
                if (score <= 40) { el.className = "text-5xl score-blue"; lbl.innerText = "安心"; lbl.className = "text-[10px] font-black bg-blue-tag px-4 py-1 rounded-full"; }
                else if (score <= 60) { el.className = "text-5xl score-yellow"; lbl.innerText = "注意"; lbl.className = "text-[10px] font-black bg-yellow-tag px-4 py-1 rounded-full"; }
                else { el.className = "text-5xl score-red"; lbl.innerText = "警戒"; lbl.className = "text-[10px] font-black bg-red-tag px-4 py-1 rounded-full"; }
            };
            renderScore(s1, 'score-1', 'label-1');
            renderScore(s2, 'score-2', 'label-2');
            const msgEl = document.getElementById('result-message');
            msgEl.innerText = s2 > 40 ? "お口の中に特定のニオイ原因が隠れている可能性があります。一度、下関市の健診で詳しくチェックしてみませんか？" : "現在は大きなリスクは見られません。日頃の水分補給と清潔なケアを続けていきましょう！";
            msgEl.className = `bg-white p-6 rounded-3xl mb-10 shadow-md border-l-8 ${s2 > 40 ? 'border-red-400' : 'border-sky-400'} text-sm font-bold text-slate-700`;

            document.getElementById('advice-list').innerHTML = [...new Set(adviceSet)].slice(0, 4).map(adv => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-xs font-bold text-slate-600 flex items-start">
                    <span class="text-sky-400 mr-2">●</span>${adv}
                </div>
            `).join('');

            sendData(Math.round(s1), Math.round(s2));
        }

        async function sendData(s1, s2) {
            if (!lineProfile || !GAS_URL) return;
            const data = { name: lineProfile.displayName, userId: lineProfile.userId, s1: s1, s2: s2 };
            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(e => console.error("Send Error:", e));
        }
    </script>
</body>
</html>
